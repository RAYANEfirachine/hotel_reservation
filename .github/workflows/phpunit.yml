name: PHPUnit

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    phpunit:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                php: ["8.2"]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v4
              with:
                  php-version: ${{ matrix.php }}
                  extensions: pdo_sqlite

            - name: Install Composer dependencies
              run: composer install --no-progress --no-suggest --prefer-dist

            - name: Prepare test environment
              run: |
                  mkdir -p var
                  touch var/test.sqlite
              env:
                  APP_ENV: test
                  DATABASE_URL: "sqlite:///%GITHUB_WORKSPACE%/var/test.sqlite"

            - name: Run PHPUnit
              env:
                  APP_ENV: test
                  DATABASE_URL: "sqlite:///%GITHUB_WORKSPACE%/var/test.sqlite"
              run: php -d memory_limit=2G bin/phpunit --colors=always
